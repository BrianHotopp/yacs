/* index.js - file for global event listeners and the primary setup function */

/* Global key press callback. Handles any key pressed at any time on any page
   anywhere. */
function handleKeydown(event) {
  var c = event.keyCode;
  if( ((c === 37) || (c === 38)) &&
      (nsUser.currentPage == nsYacs.schedulePage) ) {
    // Up/Left
    movePrevSchedule();
  }
  else if ( ((c === 39) || (c === 40)) &&
	    (nsUser.currentPage === nsYacs.schedulePage) ) {
    // Right/Down
    moveNextSchedule();
  }
  else {
    // NOTE: The behavior focusing most key presses on the searchbar only
    // works because there is only one text input in the whole site. If
    // another is ever added, that behavior must be removed or modified.
    nsYacs.searchbar.focus();
  }
}

function handleResize(event) {
  // No special resize behavior is implemented for the course or schedule pages
  if(nsUser.currentPage === nsYacs.homePage) {
    // On the home page, check the new width and determine whether it needs
    // to reset the number of columns
    if(getNumHomePageColumns() !== nsUser.numHomePageColumns) {
      /* TODO: do stuff to strip away the table tags and reassign schools.
	 This will require rewriting setupHomePage() to strip out the initial
	 <schools> tag before it does this, moving the school-shuffling code
	 into a separate function that can be called by both this and
	 setupHomePage(). Alternatively, this could be approached by removing
	 all tags in div#content (so it has just a bunch of <school> tags),
	 then calling that function, which is designed to operate on a
	 div#content with only <school> children, or a DOMstring of same.
	 All in all it's probably best left until we use a templating framework
	 here, thus it just reloads the home page for now.
      */
      loadHomePage();
    }
  }
}


/* Setup function. Initializes all data that needs to be used by this script,
   and adds any necessary event listeners. */
function setupPage() {
  // Initialize all variables in the yacs namespace
  nsYacs.contentContainer = document.getElementById("content");
  nsYacs.homeButton = document.getElementById("page-title");
  nsYacs.schedButton = document.getElementById("schedule-btn");
  nsYacs.searchbar = document.getElementById("searchbar");

  // Add click event to the YACS button
  nsYacs.homeButton.addEventListener("click", loadHomePage);

  // Add click event to the schedule button
  nsYacs.schedButton.addEventListener("click", loadSchedules);
  
  // Add enter key listener to the searchbar
  nsYacs.searchbar.addEventListener("keyup", function(event) {
    if(event.keyCode === 13) {
      if(nsYacs.searchbar.value)
        loadCourses("/api/v5/courses.xml?search=" + nsYacs.searchbar.value);
      else
        loadHomePage();
    }
  });

  // General keydown event listener.
  // It goes here because global keyboard events should be bound to document,
  // and that only once.
  document.addEventListener("keydown", function(event) {
    handleKeydown(event);
  });

  // General resize event listener
  window.addEventListener("resize", handleResize);
  
  // Load the default home page
  loadHomePage();

  // Bind History.js logging to state changes
  History.Adapter.bind(window, 'statechange', function(){
    var State = History.getState();
  });
}

// Only actually run this when the page finishes loading
document.addEventListener("DOMContentLoaded", setupPage, false);
